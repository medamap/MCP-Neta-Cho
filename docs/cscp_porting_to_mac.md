# CSCP Mac 移植プロジェクト

## プロジェクト概要
[CommonSourceCodeProject](https://github.com/medamap/CommonSourceCodeProject) を Mac/iOS に移植する。

## 移植手順

### (A) メインの移植作業

#### 1. エミュレータOS依存部の移植
- `src/win32/*` 及び `src/Android/*` を参考にOS依存部分を Mac 用に移植
- iPhone/iPad にも移植するため `src/Xcode/*` ディレクトリに配置
- OS依存機能の実装

#### 2. メインループの移植
- `src/win32/winmain.cpp` 及び `src/Android/android_main.cpp` を参考に移植
- `src/Xcode/xcode_main_*.swift` として実装（Objective-Cではなく Swift を使用）
- 機能別にファイルを分割：
  - メニュー処理
  - グラフィック処理
  - キー入力処理
  - イベント処理
  - ファイル処理

#### 3. エミュレータコアの移植
- 対象: `src/*.cpp|h`, `src/vm/*.cpp|h`, `src/vm/*/*.cpp|h`
- **機種非依存のため原則変更なし** (*4)
- Apple環境のC++処理系での互換性維持に必要な場合のみ変更
- 変更時の規則：
  - プリプロセッサで `__APPLE__` を使用
  - 条件コンパイルで既存環境との互換性を維持
  - コメントに `// Medamap and Claude : {変更理由}` を追記

#### 4. EmuCore の構築
- (1)と(3)をビルドしライブラリ化
- Swift からアクセスするためのブリッジを作成
- SwiftPM パッケージ化
- パッケージのメソッドコールエントリ：
  - EMUクラスのパブリックメソッド
  - パブリックフィールドのgetter/setter
  - OS依存部処理へのアクセス機能
  - ini ファイルなどの設定情報へのアクセス
  - メニューバー構造情報

#### 5. 最終アプリケーション構築
- (2)のメインループ処理と(4)のEmuCoreパッケージをリンク

### (B) ビルド環境の構築

#### 多段階ビルドプロセス (*1)
1. エミュコアビルド環境の自動生成
2. Swiftビルド環境の構築
3. エミュコアビルド
4. エミュコアSwiftPMパッケージビルド
5. Swiftメインループビルド
6. エミュコアSwiftPMパッケージとSwiftメインループとのリンクによるAppビルド

#### ビルド設定
- 100機種以上のレトロパソコンに対応
- `CMakeLists.txt` を使用（AndroidStudio版を参考）
- 各機種用のビルド環境を自動生成

#### プリプロセッサシンボル (*3)
- 各機種で必要な機能のON/OFF制御
- 例: X1では `src/vm/x1/x1.h` で周辺機器エミュレーションを設定
- シンボル定義場所：
  - `src/vm/*/*.h` (各機種のメインコンポーネントヘッダ)
  - `CMakeLists.txt`
  - vcxproj ファイル（Windows版）

#### ビルドターゲット定義 (*2)
- `_X1TURBO.txt`, `_PC8801MA.txt` などでビルドターゲットを指定
- メインループは全機種共通（`winmain.cpp`, `android_main.cpp`）
- プリプロセッサで機能の有効/無効を制御

## 開発体制

### マルチエージェント開発 (*5)
複数の Claude code ターミナルを起動し、責任範囲を分割：

#### エージェント構成案
- ビルド環境整備用エージェント
- エミュコア整備用エージェント
- メインループ用エージェント
- SwiftPMパッケージ担当
- アプリ構築担当
- エミュコアコードレビュー担当
- メインループコードレビュー担当

#### エージェント間連携
- 連絡用ファイルを中間データとして使用
- 例: エージェントAは `a.md` に書き込みのみ、エージェントB/Cは `a.md` を参照
- 書き込み先・読み出し元を明確に定義

### Git ブランチ戦略
- スタート地点: `develop` ブランチ
- 作業ブランチ: `feature/mac-platform-support2`
- 必要に応じてサブブランチを作成

## 重要事項

1. **エミュコアの挙動は変更しない** - C++処理系の互換性維持のための修正のみ許可
2. プリプロセッサシンボルの正確な指定が必要
3. 100機種以上の対応を考慮した自動化
4. 作業の記録と復旧可能性の確保