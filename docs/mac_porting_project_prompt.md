# CommonSourceCodeProject Mac/iOS移植プロジェクト

## プロジェクト概要
Windows/AndroidエミュレータプロジェクトをMac/iOS向けに移植する大規模プロジェクト。

## 移植メソッド

### (A) アプリケーション構築

#### (1) エミュレータOS依存部の移植
- src/win32/* 及び src/Android/* を参考にOS依存部分を Mac 用に移植
- iPhone/iPad にも移植するため src/Xcode/* が妥当

#### (2) メインループの移植
- src/win32/winmain.cpp 及び src/Android/android_main.cpp を参考に、メインループ処理を移植
- src/Xcode/xcode_main_*.swift あたりが妥当（Objective-Cではない理由は後述）
- メインループ処理は非常に大きいため、Xcode版では分割が必要
  - メニュー
  - グラフィック
  - キー入力
  - イベント処理
  - ファイル処理

#### (3) エミュレータコアの移植
- src/*.cpp|h src/vm/*.cpp|h src/vm/*/*.cpp|h 
- 機種非依存のため変更しない
- Apple環境のC++処理系の互換性維持のための変更のみ許可
  - プリプロセッサで __APPLE__ などを使用
  - 条件コンパイルで従来処理系とApple系C++の両対応
  - コメントに `// Medamap and Claude : {変更理由}` を付加

#### (4) EmuCore の構築
- (1)と(3)をビルドし、ライブラリ化
- ライブラリメソッドのエントリを呼び出すブリッジ作成
- SwiftPMパッケージ化
- パッケージのメソッドコールエントリ：
  - EMUクラスのパブリックメソッド
  - パブリックフィールドgetter/setter
  - OS依存部処理へのアクセス機能
  - ini設定情報へのアクセス
  - メニューバー構造情報

#### (5) 最終アプリケーション構築
- (2)のメインループ処理を(4)のEmuCoreパッケージとリンク

### (B) ビルド環境構築

100機種以上のレトロパソコンに対応するビルド環境の構築。
CMakeLists.txtを使用した自動生成。

多段階ビルド：
1. エミュコアビルド環境の自動生成
2. Swiftビルド環境の構築
3. エミュコアビルド
4. エミュコアSwiftPMパッケージビルド
5. Swiftメインループビルド
6. エミュコアSwiftPMパッケージとSwiftメインループとのリンクによるAppビルド

## 重要な注意事項

### (*1) プリプロセッサシンボル
- 各種エミュレータ生成時に必要なプリプロセッサシンボルが定義される
- 例：X1は src/vm/x1/x1.h で周辺機器エミュレーションの有効無効を設定
- src/win32/winmain.cpp や src/Android/android_main.cpp でも条件分岐

### (*2) ビルドターゲット
- エミュコア部はレトロパソコンによってビルドターゲットが異なる
- 定義：_X1TURBO.txt、_PC8801MA.txt など
- プリプロセッサシンボル：
  - src/vm/*/*.h（pc8001.h、x1.h など）
  - CMakeLists.txt
  - vcxprojファイル

### (*3) メインループ
- 全レトロパソコン共通のソース（winmain.cpp、android_main.cpp）
- 機能の有効/無効はプリプロセッサで対応

### (*4) エミュコアの不変性
- EmuCoreの挙動は変更禁止
- C++処理系による互換性維持のための修正のみ許可

### (*5) エージェント分割戦略
責任範囲を分割した複数のClaude codeエージェント：
- ビルド環境整備用エージェント
- エミュコア整備用エージェント  
- メインループ用エージェント
- SwiftPMパッケージ担当
- アプリ構築担当
- エミュコアコードレビュー担当
- メインループコードレビュー担当

連携用ファイル：
- 各エージェントが連携するための中間データファイル
- 書き込み権限と読み出し権限を明確化

### (*6) Gitブランチ戦略
- スタート地点：develop
- feature/mac-platform-support2 を作成
- 必要に応じて追加ブランチを検討